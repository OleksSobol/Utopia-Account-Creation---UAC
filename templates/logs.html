{% extends "base.html" %}

{% block title %}Live Log Viewer - Utopia Admin{% endblock %}

{% block nav_subtitle %}Live Log Monitoring{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Header -->
    <div class="gradient-bg rounded-2xl shadow-xl p-8 mb-8 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-3xl font-bold mb-2">
                    <i class="fas fa-file-alt mr-3"></i>Live Log Viewer
                </h2>
                <p class="text-blue-100">Monitor application logs in real-time</p>
            </div>
            <div class="hidden md:block">
                <i class="fas fa-stream text-6xl opacity-20"></i>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Auto-refresh Toggle -->
            <div>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input 
                        type="checkbox" 
                        id="autoRefresh"
                        checked
                        class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    >
                    <span class="text-sm font-semibold text-gray-700">
                        <i class="fas fa-sync-alt mr-1"></i>Auto-refresh
                    </span>
                </label>
                <p class="text-xs text-gray-500 mt-1 ml-7">Updates every 3 seconds</p>
            </div>

            <!-- Refresh Interval -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Refresh Interval (sec)</label>
                <input 
                    type="number" 
                    id="refreshInterval" 
                    value="3"
                    min="1"
                    max="60"
                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
            </div>

            <!-- Lines to Display -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Lines to Display</label>
                <select 
                    id="lineCount" 
                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                    <option value="50">50 lines</option>
                    <option value="100" selected>100 lines</option>
                    <option value="200">200 lines</option>
                    <option value="500">500 lines</option>
                    <option value="1000">1000 lines</option>
                    <option value="5000">5000 lines</option>
                    <option value="999999">All lines (may be slow)</option>
                </select>
            </div>

            <!-- Search Filter -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-search mr-1"></i>Search Filter
                </label>
                <input 
                    type="text" 
                    id="searchFilter" 
                    placeholder="e.g., ERROR, INFO, orderref"
                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center justify-between mt-4 pt-4 border-t-2 border-gray-100">
            <div class="flex space-x-3">
                <button 
                    onclick="loadLogs()"
                    class="flex items-center px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold"
                >
                    <i class="fas fa-sync mr-2"></i>Refresh Now
                </button>
                <button 
                    onclick="clearLogDisplay()"
                    class="flex items-center px-4 py-2 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-semibold"
                >
                    <i class="fas fa-eraser mr-2"></i>Clear Display
                </button>
                <button 
                    onclick="downloadLogs()"
                    class="flex items-center px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-semibold"
                >
                    <i class="fas fa-download mr-2"></i>Download Logs
                </button>
            </div>
            <div class="text-sm text-gray-600">
                <span id="logStatus" class="px-4 py-2 rounded-lg bg-gray-100 font-semibold">
                    <i class="fas fa-circle text-gray-400 mr-2"></i>Ready
                </span>
            </div>
        </div>
    </div>

    <!-- Log Display -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">
                <i class="fas fa-terminal mr-2 text-blue-600"></i>{{ log_file }}
            </h3>
            <div class="text-sm text-gray-600">
                <span id="logStats">0 lines displayed</span>
            </div>
        </div>
        
        <div 
            id="logContent" 
            class="bg-gray-900 text-green-400 font-mono text-sm p-6 rounded-lg min-h-[600px] max-h-[800px] overflow-y-auto custom-scrollbar whitespace-pre-wrap break-all"
        >
            <div class="text-gray-500 text-center py-20">
                <i class="fas fa-file-alt text-6xl mb-4 opacity-50"></i>
                <p class="text-lg">Loading logs...</p>
            </div>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alertContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
{% endblock %}

{% block extra_js %}
<style>
/* Custom scrollbar for log viewer */
#logContent::-webkit-scrollbar {
    width: 12px;
}
#logContent::-webkit-scrollbar-track {
    background: #1f2937;
    border-radius: 6px;
}
#logContent::-webkit-scrollbar-thumb {
    background: #4b5563;
    border-radius: 6px;
}
#logContent::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
}

/* Log level color coding */
.log-error { color: #ef4444; font-weight: bold; }
.log-warning { color: #f59e0b; font-weight: bold; }
.log-info { color: #10b981; }
.log-debug { color: #60a5fa; }
.log-critical { color: #dc2626; font-weight: bold; text-decoration: underline; }

/* Highlight search matches */
.search-highlight {
    background-color: #fbbf24;
    color: #000;
    padding: 2px 4px;
    border-radius: 2px;
}
</style>

<script>
let autoRefreshInterval = null;
let lastLogContent = '';
let isAutoScrollEnabled = true;

document.addEventListener('DOMContentLoaded', function() {
    loadLogs();
    
    // Setup auto-refresh toggle
    document.getElementById('autoRefresh').addEventListener('change', function() {
        if (this.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });
    
    // Setup refresh interval change
    document.getElementById('refreshInterval').addEventListener('change', function() {
        if (document.getElementById('autoRefresh').checked) {
            stopAutoRefresh();
            startAutoRefresh();
        }
    });
    
    // Setup search filter
    document.getElementById('searchFilter').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loadLogs();
        }
    });
    
    // Detect manual scroll (disable auto-scroll to bottom if user scrolls up)
    const logContent = document.getElementById('logContent');
    logContent.addEventListener('scroll', function() {
        const isAtBottom = logContent.scrollHeight - logContent.scrollTop <= logContent.clientHeight + 50;
        isAutoScrollEnabled = isAtBottom;
    });
    
    // Start auto-refresh by default
    startAutoRefresh();
});

function startAutoRefresh() {
    const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
    autoRefreshInterval = setInterval(loadLogs, interval);
    updateStatus('Auto-refresh enabled', 'success');
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
    updateStatus('Auto-refresh disabled', 'info');
}

async function loadLogs() {
    try {
        const lines = document.getElementById('lineCount').value;
        const search = document.getElementById('searchFilter').value;
        
        updateStatus('Loading...', 'loading');
        
        let url = `/api/logs/read?lines=${lines}`;
        if (search) {
            url += `&search=${encodeURIComponent(search)}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            const logContent = document.getElementById('logContent');
            const wasAtBottom = isAutoScrollEnabled;
            
            // Format and color-code the log content
            let formattedContent = data.content;
            
            // Color code log levels
            formattedContent = formattedContent
                .replace(/CRITICAL/g, '<span class="log-critical">CRITICAL</span>')
                .replace(/ERROR/g, '<span class="log-error">ERROR</span>')
                .replace(/WARNING/g, '<span class="log-warning">WARNING</span>')
                .replace(/INFO/g, '<span class="log-info">INFO</span>')
                .replace(/DEBUG/g, '<span class="log-debug">DEBUG</span>');
            
            // Highlight search matches
            if (search) {
                const regex = new RegExp(`(${search})`, 'gi');
                formattedContent = formattedContent.replace(regex, '<span class="search-highlight">$1</span>');
            }
            
            logContent.innerHTML = formattedContent || '<span class="text-gray-500">No log entries found.</span>';
            lastLogContent = data.content;
            
            // Update stats
            let statsText = `${data.displayed_lines} of ${data.total_lines} lines`;
            if (search) {
                statsText += ` (${data.filtered_lines} matched filter)`;
            }
            document.getElementById('logStats').textContent = statsText;
            
            // Auto-scroll to bottom if user hasn't manually scrolled up
            if (wasAtBottom) {
                logContent.scrollTop = logContent.scrollHeight;
            }
            
            updateStatus('Loaded', 'success');
            setTimeout(() => updateStatus('Ready', 'ready'), 2000);
        } else {
            showAlert('Failed to load logs: ' + data.error, 'error');
            updateStatus('Error', 'error');
        }
    } catch (error) {
        console.error('Error loading logs:', error);
        showAlert('Error loading logs: ' + error.message, 'error');
        updateStatus('Error', 'error');
    }
}

function clearLogDisplay() {
    const logContent = document.getElementById('logContent');
    logContent.innerHTML = '<span class="text-gray-500">Display cleared. Click "Refresh Now" to reload logs.</span>';
    document.getElementById('logStats').textContent = '0 lines displayed';
}

async function downloadLogs() {
    try {
        updateStatus('Downloading...', 'loading');
        
        const response = await fetch('/api/logs/download');
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `app_logs_${new Date().toISOString().replace(/[:.]/g, '-')}.log`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showAlert('Log file downloaded successfully', 'success');
            updateStatus('Ready', 'ready');
        } else {
            const data = await response.json();
            showAlert('Failed to download logs: ' + data.error, 'error');
            updateStatus('Error', 'error');
        }
    } catch (error) {
        console.error('Error downloading logs:', error);
        showAlert('Error downloading logs: ' + error.message, 'error');
        updateStatus('Error', 'error');
    }
}

function updateStatus(text, type) {
    const colors = {
        ready: 'bg-gray-100 text-gray-600',
        loading: 'bg-blue-100 text-blue-600',
        success: 'bg-green-100 text-green-600',
        error: 'bg-red-100 text-red-600',
        info: 'bg-yellow-100 text-yellow-600'
    };
    
    const icons = {
        ready: 'fa-circle',
        loading: 'fa-spinner fa-spin',
        success: 'fa-check-circle',
        error: 'fa-times-circle',
        info: 'fa-info-circle'
    };
    
    const statusEl = document.getElementById('logStatus');
    statusEl.className = `px-4 py-2 rounded-lg font-semibold ${colors[type] || colors.ready}`;
    statusEl.innerHTML = `<i class="fas ${icons[type] || icons.ready} mr-2"></i>${text}`;
}

function showAlert(message, type = 'info') {
    const colors = {
        info: 'bg-blue-500',
        success: 'bg-green-500',
        warning: 'bg-yellow-500',
        error: 'bg-red-500'
    };
    
    const icons = {
        info: 'fa-info-circle',
        success: 'fa-check-circle',
        warning: 'fa-exclamation-triangle',
        error: 'fa-times-circle'
    };
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 animate-fade-in`;
    alertDiv.innerHTML = `
        <i class="fas ${icons[type]}"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-4 text-xl">&times;</button>
    `;
    document.getElementById('alertContainer').appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 5000);
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>
{% endblock %}
