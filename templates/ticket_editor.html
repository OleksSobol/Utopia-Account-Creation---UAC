{% extends "base.html" %}

{% block title %}Ticket Template Editor - Utopia Admin{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Header -->
    <div class="gradient-bg rounded-2xl shadow-xl p-8 mb-8 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-3xl font-bold mb-2 flex items-center">
                    <i class="fas fa-file-alt mr-3"></i>Ticket Template Editor
                </h2>
                <p class="text-blue-100">Edit and manage customer notification templates</p>
            </div>
            <div class="hidden md:block">
                <i class="fas fa-edit text-6xl opacity-20"></i>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Templates List Sidebar -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">Templates</h3>
                    <button 
                        onclick="createNewTemplate()"
                        class="text-blue-600 hover:text-blue-800"
                        title="Create new template"
                    >
                        <i class="fas fa-plus-circle text-xl"></i>
                    </button>
                </div>
                <div id="templatesList" class="space-y-2">
                    <div class="text-center text-gray-400 py-4">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p class="text-sm">Loading templates...</p>
                    </div>
                </div>
            </div>
            
            <!-- Active Template Info -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mt-4">
                <p class="text-xs text-blue-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    <strong>Active Template:</strong> Set in <a href="/admin/config" class="underline font-semibold">Configuration</a>
                </p>
            </div>
        </div>

        <!-- Editor Area -->
        <div class="lg:col-span-3">
        <!-- Editor Area -->
        <div class="lg:col-span-3">
    <div class="bg-white rounded-2xl shadow-lg p-8">
        <!-- Template Info -->
        <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex-1 mr-4">
                    <label for="templateName" class="block text-sm font-semibold text-gray-700 mb-2">
                        Template Name <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="templateName" 
                        placeholder="Enter template name (e.g., 'New Customer Welcome')"
                        class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                    >
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-info-circle mr-1"></i>
                        Changing the name will create a new template file
                    </p>
                </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Status
                    </label>
                    <span id="saveStatus" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-600 text-sm font-semibold inline-block">
                        <i class="fas fa-circle text-gray-400 mr-2"></i>Ready
                    </span>
                </div>
            </div>

            <div hidden class="mb-4">
                <label for="templateSubject" class="block text-sm font-semibold text-gray-700 mb-2">
                    Email Subject (Optional)
                </label>
                <input 
                    type="text" 
                    id="templateSubject" 
                    placeholder="Enter email subject line"
                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                >
            </div>
        </div>

        <!-- Editor Tabs -->
        <div class="mb-4">
            <div class="flex space-x-2 border-b-2 border-gray-200">
                <button 
                    onclick="switchEditorMode('html')"
                    id="tab-html"
                    class="px-6 py-3 font-semibold text-blue-600 border-b-2 border-blue-600 -mb-0.5"
                >
                    <i class="fas fa-code mr-2"></i>HTML Editor
                </button>
                <button 
                    onclick="switchEditorMode('preview')"
                    id="tab-preview"
                    class="px-6 py-3 font-semibold text-gray-600 hover:text-gray-800"
                >
                    <i class="fas fa-eye mr-2"></i>Preview
                </button>
            </div>
        </div>

        <!-- HTML Editor -->
        <div id="editor-html" class="mb-6">
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-semibold text-gray-700">
                        HTML Content
                    </label>
                </div>
                <textarea 
                    id="templateContent" 
                    rows="20"
                    placeholder="Enter HTML content here..."
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-mono text-sm custom-scrollbar"
                ></textarea>
            </div>

            <!-- <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
                <p class="text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Available Variables:</strong> {customer_name}, {order_ref}, {site_id}, {email}, {phone}, {address}, {city}, {state}, {zip}
                </p>
            </div> -->
        </div>

        <!-- Preview -->
        <div id="editor-preview" class="mb-6 hidden">
            <div class="border-2 border-gray-200 rounded-lg p-6 bg-gray-50 min-h-[500px] custom-scrollbar overflow-auto">
                <div id="previewContent" class="bg-white p-8 rounded-lg shadow-sm prose prose-sm max-w-none">
                    <p class="text-gray-400 italic text-center py-20">Preview will appear here...</p>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-3">
            <button 
                onclick="saveTemplate()"
                id="saveBtn"
                class="flex-1 gradient-bg hover:shadow-lg text-white font-semibold px-6 py-3 rounded-lg flex items-center justify-center"
            >
                <i class="fas fa-save mr-2"></i>Save Template
            </button>
            <button 
                onclick="saveAsNewTemplate()"
                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-3 rounded-lg flex items-center justify-center"
            >
                <i class="fas fa-plus-square mr-2"></i>Save As New
            </button>
            <button 
                onclick="downloadTemplate()"
                class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg flex items-center justify-center"
            >
                <i class="fas fa-download mr-2"></i>Download
            </button>
            <button 
                onclick="deleteTemplate()"
                class="bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-3 rounded-lg flex items-center justify-center"
            >
                <i class="fas fa-trash mr-2"></i>Delete
            </button>
            <button 
                onclick="resetEditor()"
                class="bg-gray-500 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded-lg flex items-center justify-center"
            >
                <i class="fas fa-undo mr-2"></i>Reset
            </button>
        </div>
    </div>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alertContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
{% endblock %}

{% block extra_js %}
<style>
#previewContent ul {
    list-style-type: disc;
    margin-left: 2rem;
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
}

#previewContent ol {
    list-style-type: decimal;
    margin-left: 2rem;
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
}

#previewContent li {
    margin-top: 0.25rem;
    margin-bottom: 0.25rem;
}

#previewContent p {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
}

#previewContent h1, #previewContent h2, #previewContent h3, 
#previewContent h4, #previewContent h5, #previewContent h6 {
    font-weight: bold;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
}

#previewContent h1 { font-size: 2rem; }
#previewContent h2 { font-size: 1.5rem; }
#previewContent h3 { font-size: 1.25rem; }
#previewContent h4 { font-size: 1.1rem; }

#previewContent strong, #previewContent b {
    font-weight: bold;
}

#previewContent em, #previewContent i {
    font-style: italic;
}

#previewContent a {
    color: #2563eb;
    text-decoration: underline;
}

#previewContent br {
    display: block;
    content: "";
    margin-top: 0.5rem;
}
</style>
<script>
let currentTemplate = 'new_customer';
let currentTemplateFile = 'new_desc.txt';
let originalContent = '';
let templates = {};

document.addEventListener('DOMContentLoaded', function() {
    loadTemplatesList();
});

// Load list of all available templates
async function loadTemplatesList() {
    try {
        const response = await fetch('/api/ticket-template/list');
        const data = await response.json();
        
        if (data.success) {
            const listContainer = document.getElementById('templatesList');
            
            if (data.templates.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">No templates found</p>';
                return;
            }
            
            listContainer.innerHTML = '';
            data.templates.forEach(template => {
                const templateItem = document.createElement('button');
                templateItem.className = 'w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition-colors border-2 border-transparent';
                templateItem.id = `template-${template.id}`;
                templateItem.onclick = () => loadTemplateFromList(template.id, template.filename);
                
                templateItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-sm text-gray-800 truncate">${template.name}</p>
                            <p class="text-xs text-gray-500">${template.filename}</p>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400 ml-2"></i>
                    </div>
                `;
                
                listContainer.appendChild(templateItem);
                
                // Store template data
                templates[template.id] = template;
            });
            
            // Load the first template or new_customer
            const firstTemplate = data.templates[0];
            if (firstTemplate) {
                loadTemplateFromList(firstTemplate.id, firstTemplate.filename);
            }
        }
    } catch (error) {
        console.error('Error loading templates list:', error);
        showAlert('Failed to load templates list', 'danger');
    }
}

// Highlight active template in list
function highlightActiveTemplate(templateId) {
    // Remove highlight from all templates
    document.querySelectorAll('[id^="template-"]').forEach(el => {
        el.classList.remove('border-blue-500', 'bg-blue-50');
    });
    
    // Add highlight to active template
    const activeEl = document.getElementById(`template-${templateId}`);
    if (activeEl) {
        activeEl.classList.add('border-blue-500', 'bg-blue-50');
    }
}

// Load template from list
async function loadTemplateFromList(templateId, filename) {
    try {
        const response = await fetch(`/api/ticket-template/load/${templateId}`);
        const data = await response.json();
        
        if (data.success) {
            currentTemplate = templateId;
            currentTemplateFile = filename;
            
            document.getElementById('templateName').value = data.name || templateId;
            document.getElementById('templateSubject').value = data.subject || '';
            document.getElementById('templateContent').value = data.content;
            originalContent = data.content;
            
            highlightActiveTemplate(templateId);
            updateStatus('Loaded', 'success');
            setTimeout(() => updateStatus('Ready', 'ready'), 2000);
        }
    } catch (error) {
        console.error('Error loading template:', error);
        showAlert('Failed to load template', 'danger');
    }
}

// Create new template
function createNewTemplate() {
    const newName = prompt('Enter new template name:');
    if (!newName || !newName.trim()) {
        return;
    }
    
    currentTemplate = 'new_template';
    currentTemplateFile = '';
    
    document.getElementById('templateName').value = newName.trim();
    document.getElementById('templateSubject').value = '';
    document.getElementById('templateContent').value = '';
    originalContent = '';
    
    // Remove highlight from all templates
    document.querySelectorAll('[id^="template-"]').forEach(el => {
        el.classList.remove('border-blue-500', 'bg-blue-50');
    });
    
    updateStatus('New Template', 'ready');
    showAlert('Enter template content and click "Save Template"', 'info');
}

function switchEditorMode(mode) {
    const htmlTab = document.getElementById('tab-html');
    const previewTab = document.getElementById('tab-preview');
    const htmlEditor = document.getElementById('editor-html');
    const preview = document.getElementById('editor-preview');
    
    if (mode === 'html') {
        htmlTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', '-mb-0.5');
        htmlTab.classList.remove('text-gray-600');
        previewTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', '-mb-0.5');
        previewTab.classList.add('text-gray-600');
        
        htmlEditor.classList.remove('hidden');
        preview.classList.add('hidden');
    } else {
        previewTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', '-mb-0.5');
        previewTab.classList.remove('text-gray-600');
        htmlTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', '-mb-0.5');
        htmlTab.classList.add('text-gray-600');
        
        preview.classList.remove('hidden');
        htmlEditor.classList.add('hidden');
        
        // Update preview
        updatePreview();
    }
}

function updatePreview() {
    const content = document.getElementById('templateContent').value;
    const previewContent = content
        .replaceAll(/{customer_name}/g, '<span class="bg-yellow-100 px-2 py-1 rounded">John Doe</span>')
        .replaceAll(/{order_ref}/g, '<span class="bg-yellow-100 px-2 py-1 rounded">UIA202511-038109</span>')
        .replaceAll(/{site_id}/g, '<span class="bg-yellow-100 px-2 py-1 rounded">SITE-12345</span>')
        .replaceAll(/{email}/g, '<span class="bg-yellow-100 px-2 py-1 rounded">john@example.com</span>')
        .replaceAll(/{phone}/g, '<span class="bg-yellow-100 px-2 py-1 rounded">555-0123</span>')
        .replaceAll(/{address}/g, '<span class="bg-yellow-100 px-2 py-1 rounded">123 Main St</span>')
        .replaceAll(/{city}/g, '<span class="bg-yellow-100 px-2 py-1 rounded">Springfield</span>')
        .replaceAll(/{state}/g, '<span class="bg-yellow-100 px-2 py-1 rounded">IL</span>')
        .replaceAll(/{zip}/g, '<span class="bg-yellow-100 px-2 py-1 rounded">62701</span>');
    
    document.getElementById('previewContent').innerHTML = previewContent;
}

function insertVariable(variable) {
    const textarea = document.getElementById('templateContent');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    
    textarea.value = text.substring(0, start) + variable + text.substring(end);
    textarea.focus();
    textarea.setSelectionRange(start + variable.length, start + variable.length);
}

async function saveTemplate() {
    const name = document.getElementById('templateName').value.trim();
    const subject = document.getElementById('templateSubject').value.trim();
    const content = document.getElementById('templateContent').value;
    
    if (!name || !content) {
        showAlert('Please enter a template name and content', 'danger');
        return;
    }
    
    updateStatus('Saving...', 'loading');
    
    try {
        // Generate filename from template name
        const filename = name.toLowerCase().replace(/[^a-z0-9]+/g, '_') + '.txt';
        
        const response = await fetch('/api/ticket-template/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                template_id: currentTemplate,
                filename: currentTemplateFile || filename,
                name: name,
                subject: subject,
                content: content
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Template saved successfully', 'success');
            updateStatus('Saved', 'success');
            originalContent = content;
            
            // Reload templates list
            await loadTemplatesList();
            
            // Update current template reference
            if (result.filename) {
                currentTemplateFile = result.filename;
                currentTemplate = result.filename.replace('.txt', '');
                highlightActiveTemplate(currentTemplate);
            }
        } else {
            showAlert('Failed to save template: ' + result.error, 'danger');
            updateStatus('Error', 'error');
        }
    } catch (error) {
        showAlert('Error saving template: ' + error.message, 'danger');
        updateStatus('Error', 'error');
    }
}

async function saveAsNewTemplate() {
    const newName = prompt('Enter new template name:');
    if (!newName || !newName.trim()) {
        return;
    }
    
    const subject = document.getElementById('templateSubject').value.trim();
    const content = document.getElementById('templateContent').value;
    
    if (!content) {
        showAlert('Please enter template content', 'danger');
        return;
    }
    
    updateStatus('Saving...', 'loading');
    
    try {
        // Generate filename from template name
        const filename = newName.toLowerCase().replace(/[^a-z0-9]+/g, '_') + '.txt';
        
        const response = await fetch('/api/ticket-template/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                template_id: 'new_template',
                filename: filename,
                name: newName.trim(),
                subject: subject,
                content: content
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('New template created successfully', 'success');
            updateStatus('Saved', 'success');
            
            // Update form with new template
            document.getElementById('templateName').value = newName.trim();
            currentTemplateFile = result.filename || filename;
            currentTemplate = currentTemplateFile.replace('.txt', '');
            originalContent = content;
            
            // Reload templates list
            await loadTemplatesList();
            highlightActiveTemplate(currentTemplate);
        } else {
            showAlert('Failed to create template: ' + result.error, 'danger');
            updateStatus('Error', 'error');
        }
    } catch (error) {
        showAlert('Error creating template: ' + error.message, 'danger');
        updateStatus('Error', 'error');
    }
}

async function deleteTemplate() {
    if (!currentTemplateFile) {
        showAlert('No template selected to delete', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete "${document.getElementById('templateName').value}"?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/ticket-template/delete/${currentTemplate}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: currentTemplateFile })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Template deleted successfully', 'success');
            
            // Clear form
            document.getElementById('templateName').value = '';
            document.getElementById('templateSubject').value = '';
            document.getElementById('templateContent').value = '';
            originalContent = '';
            currentTemplate = '';
            currentTemplateFile = '';
            
            // Reload templates list
            await loadTemplatesList();
        } else {
            showAlert('Failed to delete template: ' + result.error, 'danger');
        }
    } catch (error) {
        showAlert('Error deleting template: ' + error.message, 'danger');
    }
}

function downloadTemplate() {
    const content = document.getElementById('templateContent').value;
    const name = document.getElementById('templateName').value.trim() || 'template';
    
    const blob = new Blob([content], { type: 'text/html' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${name.toLowerCase().replace(/\s+/g, '_')}.html`;
    link.click();
    
    showAlert('Template downloaded', 'success');
}

function resetEditor() {
    if (confirm('Are you sure you want to reset? Any unsaved changes will be lost.')) {
        document.getElementById('templateContent').value = originalContent;
        updatePreview();
        showAlert('Template reset to last saved version', 'info');
    }
}

function updateStatus(text, type) {
    const colors = {
        ready: 'bg-gray-100 text-gray-600',
        loading: 'bg-blue-100 text-blue-600',
        success: 'bg-green-100 text-green-600',
        error: 'bg-red-100 text-red-600'
    };
    
    const icons = {
        ready: 'fa-circle',
        loading: 'fa-spinner fa-spin',
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle'
    };
    
    const status = document.getElementById('saveStatus');
    status.className = `px-4 py-2 rounded-lg ${colors[type]} text-sm font-semibold inline-block`;
    status.innerHTML = `<i class="fas ${icons[type]} mr-2"></i>${text}`;
}

function showAlert(message, type = 'info') {
    const colors = {
        info: 'bg-blue-500',
        success: 'bg-green-500',
        warning: 'bg-yellow-500',
        danger: 'bg-red-500'
    };
    
    const icons = {
        info: 'fa-info-circle',
        success: 'fa-check-circle',
        warning: 'fa-exclamation-triangle',
        danger: 'fa-times-circle'
    };
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 animate-fade-in`;
    alertDiv.innerHTML = `
        <i class="fas ${icons[type]}"></i>
        <span>${message}</span>
    `;
    document.getElementById('alertContainer').appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 5000);
}

async function logout() {
    try {
        const response = await fetch('/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('Logout error:', error);
    }
}
</script>
{% endblock %}